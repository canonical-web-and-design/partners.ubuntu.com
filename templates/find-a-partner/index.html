{% extends "templates/base_index.html" %}

{% block title %}Find a partner | {% endblock %}
{% block meta_description %}Browse current Ubuntu partners in hardware, software, mobile or cloud - or find a specific partner from the list.{% endblock %}
{% block meta_keywords %}Canonical, Ubuntu, partner, partnership, program, programme, carrier, telco, mobile, network, phone, smartphone, tablet, cloud, OpenStack, public cloud, infrastructure, guest, image, server, ISV, software, hardware, enablement, certify, certified, certification, PC, laptop, desktop, reseller, VAR, channel, developer{% endblock %}

{% block content %}
<div class="row row-hero no-border no-padding-bottom no-margin-bottom">
  <div class="twelve-col equal-height">
    <div class="eight-col">
      <h1>Find an Ubuntu partner</h1>
      <p class="intro">Canonical&rsquo;s network of Ubuntu partners spans the full range of technology activities. We offer partner programmes for software vendors, hardware OEMs, mobile carriers, resellers, retailers and public cloud providers. </p>
    </div>
    <div class="four-col last-col align-center align-vertically">
      <img class="priority-0" src="{{ STATIC_URL }}img/partners-search.svg" width="180" alt="Search pictogram">
    </div>
  </div>
</div><!-- /row -->

<div class="row">
  <div class="search-panel three-col">
    <div class="twelve-col">
      <form>
        <input type="text" name="search" id="search">
      </form>
    </div>
    <div class="twelve-col">
      <div class="tabbed-menu" style="display: none;">
        <ul>
          {% for filter in filters %}
          <li>
            <a href="#{{ filter.name|slugify }}" class="active">{{ filter.name }}</a>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% for filter in filters %}
        <div id="{{ filter.name|slugify }}" class="tabbed-content">
          <a href="#{{ filter.name|slugify }}" class="accordion-button slideless">{{ filter.name|lower|capfirst }}</a>
          <ul class="no-bullets">
          {% for item in filter.items %}
          <li>
            <input type="checkbox" name="{{ filter.name|slugify }}-{{ item|slugify }}" id="{{ filter.name|slugify }}-{{ item|slugify }}">
            <label for="{{ filter.name|slugify }}-{{ item|slugify }}">{{ item }}</label>
          </li>
          {% endfor %}
          </ul>
        </div>
      {% endfor %}
    </div>
  </div>
  <div id="results" class="results nine-col last-col">
      <div class="box noResults hide">
        <p>Sorry, no partners matches found.</p>
        <p>Perhaps <a href="/find-a-partner">start your search again?</a></p>
      </div>
      {% for p in partners %}
      <div class="box box-highlight clearfix twelve-col partner equal-height" data-searchText="{{ p.name }} {{ p.short_description }}" data-filter="{% for technology in p.technology.all %}technology-{{ technology.name|slugify }} {% endfor %}{% for industry_sector in p.industry_sector.all %}industry-sector-{{ industry_sector.name|slugify }} {% endfor %}{% for programme in p.programme.all %}programme-{{ programme.name|slugify }} {% endfor %}{% for service_offered in p.service_offered.all %}service-offered-{{ service_offered.name|slugify }} {% endfor %}{% for region in p.region.all %}region-{{ region.name|slugify }} {% endfor %}" >
          <div class="two-col align-center align-vertically">
            <img src="{{ p.logo }}" alt="{{ p.name }} logo" />
          </div>
          <div class="{% if p.logo %}seven-col{% else %}nine-col{% endif %} no-margin-bottom last-col">
            <h3>
            	{% if p.dedicated_partner_page or p.partner_website %}
	            	{% if p.partner_website and not p.dedicated_partner_page %}
	            		<a class="external" onclick="ga('send', 'event', 'External Link', '{{ p.name }} - find a partner page', 'From {{ p.name }} find-a-partner result link');" href="{{ p.partner_website }}">
	            	{% else %}
	            		<a onclick="ga('send', 'event', 'Internal Link', '{{ p.name }} - find a partner page', 'From {{ p.name }} find-a-partner result link');" href="/{{ p.slug }}">
	            	{% endif %}
	            		{{ p.name }}{% if p.dedicated_partner_page %}&nbsp;&rsaquo;{% endif %}
									</a>
							{% else %}
									{{ p.name }}
							{% endif %}
            </h3>
            <p>{{ p.short_description }}</p>
          </div>
          {% if p.logo %}
          {% endif %}
      </div><!-- /.box -->
      {% endfor %}
  </div><!-- /#results -->
</div><!-- /row -->

{% include "templates/_contextual-footer.html" %}

{% endblock %}

{% block footer_extra %}
<script>
YUI().use('autocomplete-base', 'autocomplete-filters', 'node-event-simulate', function (Y) {
  // Create a custom PartnerFilter class that extends AutoCompleteBase.
  var PartnerFilter = Y.Base.create('partnerFilter', Y.Base, [Y.AutoCompleteBase], {
    initializer: function () {
      this._bindUIACBase();
      this._syncUIACBase();
    }
  }),

  // Create instance
  search = new PartnerFilter({
    inputNode: '#search',
    minQueryLength: 0,
    queryDelay: 0,

    // Immediately-invoked function to gather data
    source: (function () {
      var results = [];

      Y.all('#results > .partner').each(function (node) {
        results.push({
          node: node,
          searchText: node.getAttribute('data-searchText')
        });
      });

      return results;
    }()), // <-- Note the parens. This invokes the function immediately.
          //     Remove these to invoke the function on every query instead.

    resultTextLocator: 'searchText',

    // filter on part-words
    resultFilters: 'subWordMatch'
  });

  // Returns true if there are any matched results
  function matchesExist() {
    if (Y.all('#results > .partner').size() == (Y.all('#results > .notSearchMatch').size() + Y.all('#results > .notFilterMatch').size())){
      return false;
    } else {
      return true;
    }
  }

  function updateNoResultsMessage(matchesExist) {
    if (matchesExist){
      Y.one('#results .noResults').addClass('hide');
    } else {
      Y.one('#results .noResults').removeClass('hide');
    }
  }

  // Subscribe to the "results" event
  search.on('results', function (e) {
    Y.all('#results > .partner').addClass('notSearchMatch');

    Y.Array.each(e.results, function (result) {
      result.raw.node.removeClass('notSearchMatch');
    });

    updateNoResultsMessage(matchesExist());
  });

  //Adds a listener to checkboxes to filter results
  var checkboxes = Y.all('.search-panel input[type=checkbox]');
  checkboxes.on('change', function (e) {
    var checkbox = e.target;
    var checked = checkbox.get('checked');
    var attributeName = checkbox.get('id')
    updateFilter(attributeName, checked);
    updateNoResultsMessage(matchesExist());
  });

  var filters = [];
  //Adds the provided filter and filters the results accordingly
  function updateFilter(name, add) {
    filters[name] = add;
    partners = Y.all('.partner');
    partners.each(function(node) {
      node.addClass('notFilterMatch');
    });
    partners.each(function(node) {
      dataFilter = node.getAttribute('data-filter');
      for (var name in filters) {
        if (filters[name] == true && dataFilter.indexOf(name) != -1) {
          node.removeClass('notFilterMatch');
        }
      }
    });
    

    if (filters.indexOf(true) == -1) {
      if (partners.size() == Y.all('.notFilterMatch').size()) {
        partners.each(function(node){
          node.removeClass('notFilterMatch');
        });
      }
    }
  }

  //Get specified query param
  function getParameterByName(name) {
    name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
    var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"), results = regex.exec(location.search);
    return results == null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
  }

  //check any checkboxes that match
  function populateCheckboxes() {
    var filters = [], groupedFilters = [];
    {% for filter in filters %}
    groupedFilters['{{ filter.name|slugify }}'] = getParameterByName('{{ filter.name|slugify }}');
    //TODO - pop open any filters that are used
    {% endfor %}
    for (var key in groupedFilters) {
      if (groupedFilters[key]) {
        var filters = groupedFilters[key].split(' ');
        for (var filter in filters) {
          var checkbox = key + '-' + filters[filter];
          var checkboxObject = Y.one('#'+checkbox);
          if (checkboxObject != null) {
            checkboxObject.setAttribute('checked','checked');
            updateFilter(checkbox, true);
            Y.one('#'+key).addClass('open');
          }
        }
      }
    }
  }

  //auto-fill text serarch
  function populateTextbox() {
    var searchbox = Y.one('#search');
    var searchText = getParameterByName('search');
    if (searchbox != null && searchText != null) {
      searchbox.focus();
      searchbox.set('value', searchText);
    }
  }

  populateCheckboxes();
  populateTextbox();
});
</script>

{% endblock %}